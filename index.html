<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Vacanza Alghero - Pensiamo a tutto noi, Al miglior prezzo</title>
    <meta name="description" content="Case Vacanza ad Alghero - Le migliori soluzioni per le tue vacanze in Sardegna">
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-hidden">
        <div class="container-nav">
            <div class="nav-brand">
                <img src="images/logotest.png" alt="Case Vacanza Alghero Logo">
            </div>
            
            <ul class="nav-menu-center">
                <li><a href="#home">HOME</a></li>
                <li><a href="#properties">APPARTAMENTI</a></li>
                <li><a href="#about">CHI SIAMO</a></li>
                <li><a href="#services">SERVIZI</a></li>
                <li><a href="#contact">CONTATTI</a></li>
            </ul>
            
            <div class="nav-right">
                <a href="https://wa.me/39XXXXXXXXX" class="btn-nav-primary">Contattaci WhatsApp</a>
                <span class="nav-language">ITA â–¼</span>
                <a href="tel:+39XXXXXXXXX" class="nav-icon"><i class="ph ph-phone"></i></a>
                <a href="mailto:info@casavacanzealghero.it" class="nav-icon"><i class="ph ph-envelope"></i></a>
            </div>
            
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Fixed Top Icons (Apulia Style) -->
    <div class="fixed-top-icons">
        <div class="fixed-icons-left">
            <a href="tel:+39XXXXXXXXX" class="fixed-icon" title="Telefono">
                <i class="ph ph-phone"></i>
            </a>
            <a href="mailto:info@casevacanzealghero.it" class="fixed-icon" title="Email">
                <i class="ph ph-envelope"></i>
            </a>
        </div>
        <div class="fixed-icons-center">
            <img src="images/logotest.png" alt="Case Vacanza Alghero" class="fixed-logo">
        </div>
        <div class="fixed-icons-right">
            <button class="fixed-icon mobile-menu-toggle" id="mobileMenuBtn" aria-label="Menu">
                MenÃ¹
                <span class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </button>
        </div>
    </div>

    <!-- Hero Section -->
    <section id="home" class="hero">
        <video class="hero-video" autoplay muted loop playsinline>
            <source src="images/Sfondo/Video-hero.mp4" type="video/mp4">
        </video>
        <div class="hero-overlay"></div>
        
        <!-- Floating particles -->
        <div class="hero-particles">
            <span></span><span></span><span></span><span></span><span></span>
            <span></span><span></span><span></span>
        </div>

        <div class="hero-content">
            <div class="hero-badge animate-hero">
                <span class="badge-line"></span>
                <span class="badge-text">ALGHERO Â· SARDEGNA</span>
                <span class="badge-line"></span>
            </div>
            <h1 class="hero-title animate-hero">Case Vacanza<br><span class="hero-title-accent">Alghero</span></h1>
            <div class="hero-divider animate-hero">
                <span class="divider-line"></span>
            </div>
            <p class="hero-subtitle animate-hero">Il tuo soggiorno perfetto tra mare cristallino e centro storico</p>
            <div class="hero-stars">
                <i class="ph-fill ph-star star-icon"></i>
                <i class="ph-fill ph-star star-icon"></i>
                <i class="ph-fill ph-star star-icon"></i>
                <i class="ph-fill ph-star star-icon"></i>
                <i class="ph-fill ph-star star-icon"></i>
            </div>
        </div>
        <div class="hero-bottom-cta">
            <span class="cta-text">SCOPRI GLI ALLOGGI</span>
            <i class="ph ph-arrow-down cta-arrow"></i>
        </div>
    </section>



    <!-- Introduction Section -->
    <section id="about" class="intro-section-dark">
        <div class="intro-editorial">
            <span class="intro-eyebrow">I NOSTRI ALLOGGI AD ALGHERO</span>
            <h2 class="intro-headline">Il tuo soggiorno,<br>la nostra <span class="intro-accent">passione</span></h2>
            <p class="intro-lead">Appartamenti, camere e residence selezionati nel cuore della Riviera del Corallo.<br>Con la <a href="#" class="roulette-link" onclick="openRoulettePopup(); return false;">Formula Roulette</a> trovi sempre un alloggio disponibile al tuo budget.</p>
            <div class="intro-features">
                <div class="intro-feature-item">
                    <i class="ph ph-house-line"></i>
                    <span>200+ strutture<br><small>ad Alghero</small></span>
                </div>
                <div class="intro-feature-divider"></div>
                <div class="intro-feature-item">
                    <i class="ph ph-waves"></i>
                    <span>Vicino al mare<br><small>e al centro storico</small></span>
                </div>
                <div class="intro-feature-divider"></div>
                <div class="intro-feature-item">
                    <i class="ph ph-tag"></i>
                    <span>Miglior tariffa<br><small>prenotando direttamente</small></span>
                </div>
                <div class="intro-feature-divider"></div>
                <a href="#" class="intro-feature-item intro-feature-link" onclick="openRoulettePopup(); return false;">
                    <i class="ph ph-shuffle"></i>
                    <span>Formula Roulette<br><small>Sempre un alloggio al tuo budget</small></span>
                </a>
            </div>
        </div>
    </section>

    <!-- Properties Section -->
    <section id="properties" class="properties-section-dark">
        <div class="container-full" id="propertiesContainer">
            <!-- Property cards will be loaded dynamically from properties-data.json -->

        </div>
    </section>

    <!-- Gallery Section -->
    <section class="gallery-section-mosaic">
        <div class="container">
            <div class="gallery-intro">
                <div class="gallery-left">
                    <div class="logo-section">
                        <img src="images/logotest.png" alt="Logo Case Vacanza Alghero" class="logo-small">
                    </div>
                    <div class="gallery-text">
                        <h2>Alghero, la Perla della Sardegna</h2>
                        <p>Mare cristallino, spiagge di sabbia bianca e un centro storico ricco di fascino mediterraneo ti aspettano.</p>
                        <p>Scopri la Riviera del Corallo, gusta la cucina catalano-sarda e immergiti nella cultura unica di questa perla del nord-ovest.</p>
                    </div>
                </div>
                <div class="gallery-mosaic">
                    <video src="images/video1.mp4" autoplay muted loop playsinline class="mosaic-1"></video>
                    <video src="images/video2.mp4" autoplay muted loop playsinline class="mosaic-2"></video>
                    <video src="images/video3.mp4" autoplay muted loop playsinline class="mosaic-3"></video>
                    <video src="images/video4.mp4" autoplay muted loop playsinline class="mosaic-4"></video>
                </div>
            </div>
            <div class="gallery-badge">
                <i class="ph ph-seal-check"></i>
                <span>OspitalitÃ  Eccellente 2026</span>
            </div>
        </div>
    </section>

    <!-- Services Section -->
    <section id="services" class="services-section-light">
        <div class="container">
            <div class="services-intro">
                <h2>I Nostri<br>Servizi</h2>
                <p class="services-subtitle"><em>Tutto ciÃ² che offriamo per il tuo soggiorno perfetto</em></p>
                <div class="services-locations">
                    <h4>APPARTAMENTI VACANZA</h4>
                    <p style="color: var(--navy-dark); font-weight: 600; font-size: 1.1rem;"><i class="ph ph-map-pin"></i> ALGHERO SARDEGNA</p>
                </div>
            </div>
            <div class="services-list">
                <div class="service-item">
                    <div class="service-icon-box"><i class="ph ph-target"></i></div>
                    <div class="service-content">
                        <h3>POSIZIONE STRATEGICA</h3>
                        <p>Nel cuore di Alghero, vicino a spiagge, ristoranti e attrazioni principali.</p>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-icon-box"><i class="ph ph-wifi-high"></i></div>
                    <div class="service-content">
                        <h3>APPARTAMENTI ACCESSORIATI</h3>
                        <p>Wi-Fi, Smart TV con Netflix, aria condizionata e tutto il comfort necessario.</p>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-icon-box"><i class="ph ph-door-open"></i></div>
                    <div class="service-content">
                        <h3>SELF CHECK-IN</h3>
                        <p>Accesso autonomo h24 senza vincoli di orario, in completa libertÃ .</p>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-icon-box"><i class="ph ph-car"></i></div>
                    <div class="service-content">
                        <h3>PARCHEGGI CONVENZIONATI</h3>
                        <p>Parcheggi privati a tariffa agevolata nelle vicinanze.</p>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-icon-box"><i class="ph ph-handshake"></i></div>
                    <div class="service-content">
                        <h3>ASSISTENZA DEDICATA</h3>
                        <p>Staff disponibile h24 per ogni necessitÃ  durante il soggiorno.</p>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-icon-box"><i class="ph ph-calendar-check"></i></div>
                    <div class="service-content">
                        <h3>DISPONIBILITÃ€ FLESSIBILE</h3>
                        <p>Contattaci per le migliori tariffe e soluzioni personalizzate.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Map Section -->
    <section id="map" class="map-section">
        <div class="container">
            <div class="section-header">
                <h2>Dove Siamo</h2>
                <p>Scopri la posizione dei nostri appartamenti e camere nel cuore di Alghero</p>
            </div>
            <div id="properties-map" class="properties-map"></div>
        </div>
    </section>

    <!-- Footer + Contact Combined -->
    <footer id="contact" class="footer-combined">
        <div class="footer-dark-banner"></div>
        <div class="footer-content-area">
            <div class="footer-inner">
                <!-- Left Side: Logo + Contacts + Links -->
                <div class="footer-info">
                    <img src="images/logotest.png" alt="Logo Case Vacanza Alghero" class="footer-logo">

                    <div class="footer-columns">
                        <div class="footer-col-left">
                            <h4 class="footer-heading">CONTATTI</h4>
                            <div class="footer-contact-list">
                                <a href="tel:+39XXXXXXXXXX" class="footer-contact-item">
                                    <i class="ph ph-phone"></i>
                                    <span>+39 XXX XXX XXXX</span>
                                </a>
                                <a href="mailto:info@casavacanzealghero.it" class="footer-contact-item">
                                    <i class="ph ph-envelope-simple"></i>
                                    <span>info@casavacanzealghero.it</span>
                                </a>
                                <div class="footer-contact-item">
                                    <i class="ph ph-map-pin"></i>
                                    <span>Alghero, Sardegna</span>
                                </div>
                            </div>
                            <div class="footer-social">
                                <a href="#" aria-label="Instagram"><i class="ph ph-instagram-logo"></i></a>
                                <a href="#" aria-label="Facebook"><i class="ph ph-facebook-logo"></i></a>
                            </div>
                        </div>
                        <div class="footer-col-right">
                            <h4 class="footer-heading">INFO</h4>
                            <ul class="footer-links">
                                <li><a href="#home">Home</a></li>
                                <li><a href="#properties">Appartamenti</a></li>
                                <li><a href="#about">Chi Siamo</a></li>
                                <li><a href="#map">Dove Siamo</a></li>
                                <li><a href="#contact">Contatti</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Right Side: Form Card (overlaps into dark) -->
                <div class="footer-form-card">
                    <h3>Scrivici troveremo la sistemazione migliore per te</h3>
                    <p class="footer-form-subtitle"><em>Ti risponderemo entro un'ora</em></p>
                    <form id="contactForm" class="footer-form">
                        <div class="form-group">
                            <label>Nome *</label>
                            <input type="text" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label>Messaggio *</label>
                            <textarea name="message" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="btn-submit-modern">Invia</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 Case Vacanza Alghero. Tutti i diritti riservati.</p>
        </div>
    </footer>

    <!-- WhatsApp Float Button -->
    <div class="whatsapp-widget">
        <div class="whatsapp-popup" id="whatsappPopup">
            <div class="whatsapp-popup-header">
                <div class="whatsapp-header-content">
                    <img src="images/logotest.png" alt="Case Vacanza" class="whatsapp-avatar">
                    <div class="whatsapp-header-text">
                        <h4>Case Vacanza Alghero</h4>
                        <span class="whatsapp-status">Online</span>
                    </div>
                </div>
                <button class="whatsapp-close" id="whatsappClose">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="whatsapp-popup-body">
                <div class="whatsapp-message">
                    <div class="whatsapp-message-bubble">
                        <p>Ciao! ðŸ‘‹</p>
                        <p>Come possiamo aiutarti?</p>
                        <span class="whatsapp-time">Online</span>
                    </div>
                </div>
            </div>
            <div class="whatsapp-popup-footer">
                <input type="text" id="whatsappInput" placeholder="Scrivi un messaggio..." class="whatsapp-input">
                <button class="whatsapp-send" id="whatsappSend">
                    <i class="ph ph-paper-plane-tilt"></i>
                </button>
            </div>
        </div>
        <button class="whatsapp-float" id="whatsappFloat" aria-label="Contattaci su WhatsApp">
            <svg class="whatsapp-circle-text" viewBox="0 0 120 120">
                <defs>
                    <path id="circlePath" d="M 60, 60 m -45, 0 a 45,45 0 1,1 90,0 a 45,45 0 1,1 -90,0" />
                </defs>
                <text class="circle-text">
                    <textPath href="#circlePath" startOffset="0%">
                        PARLA CON ME Â· PARLA CON ME Â· 
                    </textPath>
                </text>
            </svg>
            <svg viewBox="0 0 32 32" fill="white" width="32" height="32" class="whatsapp-icon">
                <path d="M16 0C7.164 0 0 7.164 0 16c0 2.8.736 5.568 2.128 8.016L0 32l8.224-2.112A15.93 15.93 0 0016 32c8.836 0 16-7.164 16-16S24.836 0 16 0zm8.48 22.848c-.352.992-2.064 1.824-2.848 1.952-.752.128-1.728.176-2.784-.176-.64-.208-1.456-.48-2.496-.944-4.368-1.936-7.216-6.32-7.44-6.608-.208-.288-1.776-2.368-1.776-4.512s1.136-3.2 1.536-3.632c.4-.432.88-.544 1.168-.544.304 0 .592.016.848.016.272 0 .624-.096 1.008.768.384.88 1.312 3.2 1.424 3.44.112.24.192.528.032.816-.16.304-.24.48-.48.752-.24.256-.496.576-.72.768-.24.224-.48.464-.208.912.272.432 1.216 2 2.608 3.232 1.792 1.584 3.296 2.08 3.76 2.32.464.224.736.192 1.008-.128.272-.32 1.168-1.36 1.488-1.84.304-.464.624-.384 1.056-.224.432.16 2.752 1.296 3.216 1.536.464.24.784.352.88.56.112.208.112 1.2-.24 2.192z"/>
            </svg>
        </button>
    </div>

    <!-- Roulette Popup Overlay -->
    <div class="roulette-overlay" id="rouletteOverlay">
        <div class="roulette-popup">
            <button class="roulette-popup-close" id="rouletteClose">
                <i class="ph ph-x"></i>
            </button>

            <!-- Step 1: Email Gate -->
            <div class="roulette-step" id="rouletteStep1">
                <div class="roulette-popup-glow"></div>
                <div class="roulette-step-content">
                    <div class="roulette-popup-badge">
                        <i class="ph ph-shuffle"></i>
                        <span>FORMULA ROULETTE</span>
                    </div>
                    <h2>Gira la ruota<br><span class="rp-accent">e scopri il tuo vantaggio</span></h2>
                    <p class="rp-desc">Inserisci la tua email per sbloccare la ruota della fortuna e vincere sconti e vantaggi esclusivi!</p>
                    <form id="emailGateForm" class="rp-email-form">
                        <div class="rp-input-wrap">
                            <i class="ph ph-envelope-simple"></i>
                            <input type="email" id="rouletteEmail" placeholder="La tua email..." required>
                        </div>
                        <button type="submit" class="rp-unlock-btn">
                            <i class="ph ph-lock-simple-open"></i>
                            Sblocca la Ruota
                        </button>
                        <p class="rp-privacy"><i class="ph ph-shield-check"></i> Niente spam, solo offerte esclusive</p>
                    </form>
                </div>
            </div>

            <!-- Step 1.5: Email Confirmation Pending -->
            <div class="roulette-step hidden" id="rouletteStepConfirm">
                <div class="roulette-popup-glow"></div>
                <div class="roulette-step-content" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ“§</div>
                    <h2 style="color: #C27A50; margin-bottom: 1rem;">Controlla la tua email!</h2>
                    <p style="color: #d4c4b0; margin-bottom: 1rem;" id="confirmEmailText">Ti abbiamo inviato un'email di conferma.</p>
                    <p style="color: #a99a8a; font-size: 0.9rem;">Clicca sul link nell'email per sbloccare la ruota della fortuna!</p>
                    <p style="color: #7a6a5a; font-size: 0.8rem; margin-top: 1.5rem;"><i class="ph ph-info"></i> Controlla anche la cartella spam</p>
                </div>
            </div>

            <!-- Step 2: Wheel Spin -->
            <div class="roulette-step hidden" id="rouletteStep2">
                <div class="roulette-popup-glow"></div>
                <div class="roulette-step-content">
                    <p class="rp-wheel-intro">Clicca al centro della ruota per girarla!</p>
                    <div class="rp-wheel-wrapper">
                        <div class="rp-wheel-pointer">
                            <svg width="36" height="36" viewBox="0 0 40 40">
                                <polygon points="20,38 8,8 32,8" fill="#C27A50" stroke="#8B5A3C" stroke-width="2"/>
                            </svg>
                        </div>
                        <canvas id="rpWheelCanvas" width="380" height="380"></canvas>
                        <button class="rp-spin-btn" id="rpSpinBtn"></button>
                        <div class="rp-leds" id="rpLeds"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Prize + Form -->
            <div class="roulette-step hidden" id="rouletteStep3">
                <div class="roulette-popup-glow rp-glow-gold"></div>
                <div class="rp-confetti" id="rpConfetti"></div>
                <div class="roulette-step-content">
                    <div class="rp-prize-section">
                        <div class="rp-trophy"><i class="ph ph-trophy"></i></div>
                        <h2 id="rpPrizeTitle">Complimenti!</h2>
                        <p class="rp-prize-text" id="rpPrizeText"></p>
                        <div class="rp-prize-code" id="rpPrizeCode"></div>
                    </div>
                    <div class="rp-prize-form">
                        <p class="rp-form-intro">Completa con i tuoi dati per usare il vantaggio:</p>
                        <form id="rpFullForm">
                            <div class="rp-form-row">
                                <div class="rp-form-group">
                                    <label><i class="ph ph-calendar-check"></i> Check-in</label>
                                    <input type="date" name="checkin" id="rpCheckin" required>
                                </div>
                                <div class="rp-form-group">
                                    <label><i class="ph ph-calendar-x"></i> Check-out</label>
                                    <input type="date" name="checkout" id="rpCheckout" required>
                                </div>
                            </div>
                            <div class="rp-form-row">
                                <div class="rp-form-group">
                                    <label><i class="ph ph-users"></i> Ospiti</label>
                                    <select name="guests" required>
                                        <option value="" disabled selected>Quanti?</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6+</option>
                                    </select>
                                </div>
                                <div class="rp-form-group">
                                    <label><i class="ph ph-wallet"></i> Budget</label>
                                    <select name="budget" required>
                                        <option value="" disabled selected>Budget</option>
                                        <option value="0-200">Fino a â‚¬200</option>
                                        <option value="200-400">â‚¬200-â‚¬400</option>
                                        <option value="400-600">â‚¬400-â‚¬600</option>
                                        <option value="600-1000">â‚¬600-â‚¬1000</option>
                                        <option value="1000+">â‚¬1000+</option>
                                    </select>
                                </div>
                            </div>
                            <div class="rp-form-row">
                                <div class="rp-form-group">
                                    <label><i class="ph ph-user"></i> Nome</label>
                                    <input type="text" name="name" placeholder="Il tuo nome" required>
                                </div>
                                <div class="rp-form-group">
                                    <label><i class="ph ph-whatsapp-logo"></i> WhatsApp</label>
                                    <input type="tel" name="phone" placeholder="+39..." required>
                                </div>
                            </div>
                            <input type="hidden" name="email" id="rpHiddenEmail">
                            <input type="hidden" name="prize" id="rpHiddenPrize">
                            <button type="submit" class="rp-submit-btn">
                                <i class="ph ph-paper-plane-tilt"></i>
                                Invia e usa il tuo vantaggio
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Roulette Popup CSS -->
    <link rel="stylesheet" href="css/roulette-popup.css">

    <!-- Roulette Popup JS -->
    <script>
    // ============================================
    // ROULETTE POPUP
    // ============================================
    (function() {
        const overlay = document.getElementById('rouletteOverlay');
        const step1 = document.getElementById('rouletteStep1');
        const stepConfirm = document.getElementById('rouletteStepConfirm');
        const step2 = document.getElementById('rouletteStep2');
        const step3 = document.getElementById('rouletteStep3');
        let userEmail = '';
        let wonPrize = null;

        // Open / Close
        window.openRoulettePopup = function() {
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        document.getElementById('rouletteClose').addEventListener('click', function() {
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        });

        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // Step 1: Email gate with Double Opt-In
        document.getElementById('emailGateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            userEmail = document.getElementById('rouletteEmail').value;
            document.getElementById('rpHiddenEmail').value = userEmail;
            
            const submitBtn = this.querySelector('button');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="ph ph-circle-notch ph-spin"></i> Invio...';
            
            try {
                const response = await fetch('/.netlify/functions/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'subscribe', email: userEmail })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('confirmEmailText').textContent = 
                        'Ti abbiamo inviato un\'email a ' + userEmail;
                    step1.classList.add('hidden');
                    stepConfirm.classList.remove('hidden');
                } else {
                    alert(data.error || 'Errore, riprova.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="ph ph-paper-plane-tilt"></i> Gira la Ruota';
                }
            } catch (err) {
                alert('Errore di connessione, riprova.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="ph ph-paper-plane-tilt"></i> Gira la Ruota';
            }
        });
        
        // Check for confirmation token on page load
        (async function checkConfirmation() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('confirm');
            if (!token) return;
            
            try {
                const response = await fetch('/.netlify/functions/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'confirm', token: token })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clean URL
                    window.history.replaceState({}, '', window.location.pathname);
                    // Open popup directly to wheel
                    userEmail = data.email || '';
                    document.getElementById('rpHiddenEmail').value = userEmail;
                    step1.classList.add('hidden');
                    step2.classList.remove('hidden');
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    initWheel();
                }
            } catch (err) {
                console.error('Confirmation error:', err);
            }
        })();

        // ============================================
        // WHEEL ENGINE
        // ============================================
        const segments = [
            { label: '10%\nSCONTO',       color: '#8B5A3C', prize: '10% di sconto sul soggiorno!', code: 'SCONTO10', glow: false },
            { label: 'CARTOLINA\nSARDA',   color: '#1a3a52', prize: 'Una cartolina sarda in omaggio!', code: 'CARTOLINA', glow: false },
            { label: '15%\nSCONTO',       color: '#A67C52', prize: '15% di sconto sul soggiorno!', code: 'SCONTO15', glow: false },
            { label: 'RIGIRA\nGRATIS',     color: '#2a4a62', prize: '', code: 'RESPIN', glow: false, respin: true },
            { label: 'SOGGIORNO\nGRATIS',  color: '#0d0d0d', prize: 'SOGGIORNO COMPLETAMENTE GRATIS!', code: 'GRATIS', glow: true },
            { label: '2%\nSCONTO',        color: '#1a3a52', prize: '2% di sconto sul soggiorno!', code: 'SCONTO2', glow: false },
            { label: '10%\nSCONTO',       color: '#8B5A3C', prize: '10% di sconto sul soggiorno!', code: 'SCONTO10', glow: false },
            { label: 'BUON\nVIAGGIO!',    color: '#0a1e2e', prize: 'Un augurio di buon viaggio!', code: 'AUGURI', glow: false },
        ];

        // Rigged: 85% â†’ 10% o 15% sconto (indici 0,2,6), 15% â†’ Rigira Gratis (indice 3)
        // Soggiorno Gratis (indice 4) non esce MAI
        function getTargetIndex() {
            const roll = Math.random();
            if (roll < 0.40) return 0; // 10% sconto
            if (roll < 0.65) return 2; // 15% sconto
            if (roll < 0.85) return 6; // 10% sconto (seconda)
            return 3;                  // Rigira Gratis
        }

        let canvas, ctx, centerX, centerY, radius, segAngle;
        let currentAngle = 0, isSpinning = false, hasSpun = false;
        let glowPhase = 0, glowAnimId = null;

        function initWheel() {
            canvas = document.getElementById('rpWheelCanvas');
            ctx = canvas.getContext('2d');
            centerX = canvas.width / 2;
            centerY = canvas.height / 2;
            radius = 175;
            segAngle = (2 * Math.PI) / segments.length;

            createLeds();
            drawWheel();
            startGlowAnimation();
            document.getElementById('rpSpinBtn').addEventListener('click', spinWheel);
        }

        function startGlowAnimation() {
            if (glowAnimId) return;
            function animateGlow() {
                glowPhase += 0.04;
                if (!isSpinning) drawWheel();
                glowAnimId = requestAnimationFrame(animateGlow);
            }
            animateGlow();
        }

        function createLeds() {
            const container = document.getElementById('rpLeds');
            container.innerHTML = '';
            const count = 20;
            for (let i = 0; i < count; i++) {
                const led = document.createElement('div');
                led.className = 'rp-led';
                const angle = (360 / count) * i - 90;
                const rad = angle * Math.PI / 180;
                const dist = 200;
                led.style.left = (centerX + dist * Math.cos(rad)) + 'px';
                led.style.top = (centerY + dist * Math.sin(rad)) + 'px';
                led.style.animationDelay = (i * 0.1) + 's';
                container.appendChild(led);
            }
        }

        function lightenColor(hex, amt) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.min(255, (num >> 16) + amt);
            const g = Math.min(255, ((num >> 8) & 0xFF) + amt);
            const b = Math.min(255, (num & 0xFF) + amt);
            return `rgb(${r},${g},${b})`;
        }

        function drawWheel() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Outer ring
            const ringGrad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            ringGrad.addColorStop(0, '#C27A50');
            ringGrad.addColorStop(0.3, '#F5E6D3');
            ringGrad.addColorStop(0.5, '#C27A50');
            ringGrad.addColorStop(0.7, '#8B5A3C');
            ringGrad.addColorStop(1, '#C27A50');
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius + 4, 0, 2 * Math.PI);
            ctx.fillStyle = ringGrad;
            ctx.fill();

            // Segments
            segments.forEach((seg, i) => {
                const start = currentAngle + i * segAngle;
                const end = start + segAngle;

                const mid = start + segAngle / 2;
                const gx = centerX + radius * 0.5 * Math.cos(mid);
                const gy = centerY + radius * 0.5 * Math.sin(mid);

                // GLOW effect for 'Soggiorno Gratis'
                if (seg.glow) {
                    const glowIntensity = 0.4 + 0.6 * Math.abs(Math.sin(glowPhase));
                    const sg = ctx.createRadialGradient(centerX, centerY, 30, gx, gy, radius);
                    sg.addColorStop(0, `rgba(255, 215, 0, ${glowIntensity * 0.6})`);
                    sg.addColorStop(0.5, `rgba(255, 165, 0, ${glowIntensity * 0.4})`);
                    sg.addColorStop(1, '#1a0800');
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, start, end);
                    ctx.closePath();
                    ctx.fillStyle = sg;
                    ctx.fill();
                    // Glow outer edge
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, start, end);
                    ctx.closePath();
                    ctx.clip();
                    ctx.shadowColor = `rgba(255, 215, 0, ${glowIntensity})`;
                    ctx.shadowBlur = 18;
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius - 2, start, end);
                    ctx.strokeStyle = `rgba(255, 215, 0, ${glowIntensity * 0.8})`;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    ctx.restore();
                } else {
                    const sg = ctx.createRadialGradient(centerX, centerY, 30, gx, gy, radius);
                    sg.addColorStop(0, lightenColor(seg.color, 20));
                    sg.addColorStop(1, seg.color);
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, start, end);
                    ctx.closePath();
                    ctx.fillStyle = sg;
                    ctx.fill();
                }

                // Border
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX + radius * Math.cos(start), centerY + radius * Math.sin(start));
                ctx.strokeStyle = 'rgba(255,255,255,0.12)';
                ctx.lineWidth = 1.5;
                ctx.stroke();

                // Text
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(start + segAngle / 2);
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                if (seg.glow) {
                    ctx.shadowColor = 'rgba(255, 215, 0, 0.9)';
                    ctx.shadowBlur = 10;
                } else {
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = 4;
                }
                const lines = seg.label.split('\n');
                const td = radius * 0.62;
                lines.forEach((line, li) => {
                    const yOff = (li - (lines.length - 1) / 2) * 16;
                    ctx.font = li === 0 ? 'bold 14px Poppins, sans-serif' : 'bold 11px Montserrat, sans-serif';
                    ctx.fillStyle = seg.glow ? '#FFD700' : '#fff';
                    ctx.fillText(line, td, yOff);
                });
                ctx.restore();
            });

            // Center hub
            ctx.beginPath();
            ctx.arc(centerX, centerY, 44, 0, 2 * Math.PI);
            ctx.fillStyle = '#0a1e2e';
            ctx.fill();

            const hubGrad = ctx.createRadialGradient(centerX - 6, centerY - 6, 4, centerX, centerY, 40);
            hubGrad.addColorStop(0, '#e8a468');
            hubGrad.addColorStop(0.5, '#C27A50');
            hubGrad.addColorStop(1, '#6b3a20');
            ctx.beginPath();
            ctx.arc(centerX, centerY, 38, 0, 2 * Math.PI);
            ctx.fillStyle = hubGrad;
            ctx.fill();

            ctx.beginPath();
            ctx.arc(centerX, centerY, 34, 0, 2 * Math.PI);
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1.5;
            ctx.stroke();

            // Inner dot
            ctx.beginPath();
            ctx.arc(centerX, centerY, 14, 0, 2 * Math.PI);
            ctx.fillStyle = '#0a1e2e';
            ctx.fill();
            const dg = ctx.createRadialGradient(centerX - 2, centerY - 2, 1, centerX, centerY, 12);
            dg.addColorStop(0, '#C27A50');
            dg.addColorStop(1, '#6b3a20');
            ctx.beginPath();
            ctx.arc(centerX, centerY, 11, 0, 2 * Math.PI);
            ctx.fillStyle = dg;
            ctx.fill();

            // GIRA text
            if (!hasSpun) {
                ctx.save();
                ctx.font = 'bold 11px Poppins, sans-serif';
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('GIRA!', centerX, centerY);
                ctx.restore();
            }
        }

        function spinWheel() {
            if (isSpinning) return;
            if (hasSpun) return;
            isSpinning = true;

            document.querySelector('.rp-wheel-wrapper').classList.add('is-spinning');

            const targetIndex = getTargetIndex();
            const targetMid = targetIndex * segAngle + segAngle / 2;
            const targetFinal = -Math.PI / 2 - targetMid;
            const fullSpins = 6 + Math.floor(Math.random() * 3);
            const totalRotation = fullSpins * 2 * Math.PI + (targetFinal - (currentAngle % (2 * Math.PI)));

            const startAngle = currentAngle;
            const startTime = performance.now();
            const duration = 5000 + Math.random() * 2000;

            let lastSeg = -1;

            function easeOut(t) { return 1 - Math.pow(1 - t, 4); }

            function animate(time) {
                const elapsed = time - startTime;
                const progress = Math.min(elapsed / duration, 1);
                currentAngle = startAngle + totalRotation * easeOut(progress);
                drawWheel();

                const norm = ((currentAngle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
                const curSeg = Math.floor(norm / segAngle) % segments.length;
                if (curSeg !== lastSeg) {
                    lastSeg = curSeg;
                    const ptr = document.querySelector('.rp-wheel-pointer');
                    ptr.classList.add('tick');
                    setTimeout(() => ptr.classList.remove('tick'), 80);
                }

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    document.querySelector('.rp-wheel-wrapper').classList.remove('is-spinning');
                    wonPrize = segments[targetIndex];
                    
                    // Handle respin
                    if (wonPrize.respin) {
                        setTimeout(() => {
                            // Flash 'Rigira!' message
                            const intro = document.querySelector('.rp-wheel-intro');
                            intro.textContent = 'ðŸ”„ Rigira! Hai un altro tentativo!';
                            intro.style.color = '#FFD700';
                            setTimeout(() => {
                                intro.textContent = 'Clicca al centro della ruota per girarla!';
                                intro.style.color = '';
                            }, 2000);
                        }, 500);
                        return; // Don't mark hasSpun, allow another spin
                    }
                    
                    hasSpun = true;
                    setTimeout(() => showPrizeStep(wonPrize), 500);
                }
            }
            requestAnimationFrame(animate);
        }

        function showPrizeStep(prize) {
            document.getElementById('rpPrizeTitle').textContent = '\uD83C\uDF89 Complimenti!';
            document.getElementById('rpPrizeText').textContent = 'Hai vinto: ' + prize.prize;
            document.getElementById('rpPrizeCode').innerHTML = 'Codice: <strong>' + prize.code + '</strong>';
            document.getElementById('rpHiddenPrize').value = prize.label.replace('\n', ' ') + ' - ' + prize.code;

            step2.classList.add('hidden');
            step3.classList.remove('hidden');
            createConfetti();

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rpCheckin').setAttribute('min', today);
            document.getElementById('rpCheckout').setAttribute('min', today);
            document.getElementById('rpCheckin').addEventListener('change', function() {
                const d = new Date(this.value);
                d.setDate(d.getDate() + 1);
                const min = d.toISOString().split('T')[0];
                document.getElementById('rpCheckout').setAttribute('min', min);
            });
        }

        function createConfetti() {
            const c = document.getElementById('rpConfetti');
            c.innerHTML = '';
            const colors = ['#C27A50', '#F5E6D3', '#8B5A3C', '#FFD700', '#ff6b6b', '#48dbfb'];
            for (let i = 0; i < 50; i++) {
                const p = document.createElement('div');
                p.className = 'rp-confetti-piece';
                p.style.setProperty('--x', Math.random() * 100 + '%');
                p.style.setProperty('--delay', Math.random() * 0.5 + 's');
                p.style.setProperty('--rot', (Math.random() * 720 - 360) + 'deg');
                p.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
                p.style.setProperty('--size', (4 + Math.random() * 7) + 'px');
                p.style.setProperty('--drift', (Math.random() * 160 - 80) + 'px');
                c.appendChild(p);
            }
        }

        // Final form submit
        document.getElementById('rpFullForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const fd = new FormData(this);
            const d = Object.fromEntries(fd.entries());

            const msg = `\uD83C\uDFB0 *FORMULA ROULETTE*\n\n` +
                `\uD83C\uDFC6 Vantaggio: ${d.prize}\n` +
                `\uD83D\uDC64 Nome: ${d.name}\n\uD83D\uDCE7 Email: ${d.email}\n\uD83D\uDCF1 Tel: ${d.phone}\n` +
                `\uD83D\uDCC5 Check-in: ${d.checkin}\n\uD83D\uDCC5 Check-out: ${d.checkout}\n` +
                `\uD83D\uDC65 Ospiti: ${d.guests}\n\uD83D\uDCB0 Budget: ${d.budget}`;

            window.open(`https://wa.me/39XXXXXXXXXX?text=${encodeURIComponent(msg)}`, '_blank');

            // Show success
            step3.querySelector('.roulette-step-content').innerHTML = `
                <div class="rp-success">
                    <i class="ph ph-check-circle"></i>
                    <h2>Richiesta inviata!</h2>
                    <p>Ti contatteremo entro un'ora con le migliori proposte.</p>
                    <button class="rp-close-final" onclick="document.getElementById('rouletteOverlay').classList.remove('active'); document.body.style.overflow='';">
                        Torna al sito
                    </button>
                </div>`;
        });
    })();
    </script>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="js/properties-data.js"></script>
    <script src="js/script.js"></script>
    <script src="js/map.js"></script>
</body>
</html>
